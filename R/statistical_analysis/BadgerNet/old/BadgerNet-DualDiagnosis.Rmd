---
title: "BadgerNet Analysis - Dual Diagnosis"
output: 
  pdf_document:
    toc: true
    number_sections: true
    
knit: (function(inputFile, encoding) {
      out_dir <- "../../../outputs/reports";
      rmarkdown::render(inputFile,
                        encoding=encoding,
                        output_dir=file.path(dirname(inputFile), out_dir))})
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

imp_thresh = 3

library(writexl)
library(dplyr)
library(openxlsx)
library(stringr)
library(ggplot2)
library(gtsummary)

source("~/Main work/MiscCode/r-regression-tools/r-regression-tools.R")
setwd("~/Main work/Maternity outcomes/phm-maternity/R/statistical_analysis/BadgerNet")

```

# BadgerNet

The BadgerNet dataset comes from the Birmingham Local Maternity and Neonatal System (LMNS). This dataset contains 33623 unique births from October 2020 to October 2022, with a total timespan of 730 days.

Relevent definitions from Ranjana Basra:   
- *Drug Abuse*: patient is taking/taken drugs (incluing tobacco and alocohol)

- *Alcohol Abuse*: Any amount of alcohol drinking for women who are pregnant or at risk of pregnancy.

- *Substance Abuse*: The use of illegal drugs or the use of prescription or over-the-counter drugs or alcohol for purposes other than those for which they are meant to be used, or in excessive amounts. Tobacco, alcohol, or illicit drugs or misuse of prescription drugs by pregnant women can have severe health consequences for infants


```{r load, include = FALSE}
badger_load <- load_with_ref(
  "../../../data/BadgerNet/BadgerNet-processed-withRef.xlsx",
  data_sheet = "data",
  ref_sheet = "reference",
  add_colon = TRUE,
  return_ref = TRUE
)

badger <- badger_load[[1]]
ref  <- badger_load[[2]]

rm("badger_load")

main_cols <- c("LowBirthWeight", "Premature","DualDiagnosis", "NumberOfBabies","Agelessthan20", "DomesticAbuse",  "Ethnicity", "LearningDisabilities", "Citizenship", "Unsupported")

ref <- ref %>%
  filter(Variable %in% main_cols)
```
## Reference Group

The risk ratios for each of the regressions calculated below are given relative 
to the following reference group. In this investigation, we are interested in the
influence of dual diagnosis plus the following variables:

```{r comment='', echo=FALSE, results='asis'}
 knitr::kable(ref, caption = "Reference group for logistic regression.")
```

## Population Overview

We can calculate a quick summary of the population with relation to the groups
chosen to define the reference group as shown below.

```{r get_ref_summary, results='asis', echo=FALSE}
badger %>% 
  select(c(paste(ref$Variable, ":", sep = ""), "substanceAbuse:", "MentalHealth:")) %>% 
  summarytools::dfSummary(plain.ascii = FALSE, style = "grid", valid.col = FALSE,
   graph.col = TRUE, na.col = FALSE, trim.strings = TRUE, max.string.width = 15)
```

## Variable Corrlation Matrix

```{r calc_corr, include=FALSE}
badger2 <- badger %>%
  mutate(
    deprivedArea = case_when(
    as.numeric(`IMD Quintile:`) %in% c("1", "2") ~ 1,
    TRUE ~ 0),
   Age = as.numeric(`Age:`),
   NumberOfBabies = as.numeric(`NumberOfBabies:`),
   FGM = case_when(
     `FGM:` != "Yes" ~ 1,
     TRUE ~ 0),
   Consanguineous = case_when(
     `Consanguineous_Relationship:` == "Yes" ~ 1,
     TRUE ~ 0
   ),
   BAME = case_when(
     `Ethnicity:` != "White" ~ 1,
     TRUE ~ 0
   ),
   MentalHealth = case_when(
     `MentalHealth:` == "Yes" ~ 1,
     TRUE ~ 0
   ),
   DomesticAbuse = case_when(
     `DomesticAbuse:` == "Yes" ~ 1,
     TRUE ~ 0
   ),
   SmokingAtDelivery = case_when(
     `SmokingAtDelivery:` == "Yes" ~ 1,
     TRUE ~ 0
     ),
   DrugAbuse = case_when(
     `DrugAbuse:` == "Yes" ~ 1,
     TRUE ~ 0
   ),
   AlcoholAbuse = case_when(
     `AlcoholAbuse:` == "Yes" ~ 1,
     TRUE ~ 0
   ),
   substanceAbuse = case_when(
     `substanceAbuse:` == "Yes" ~ 1,
     TRUE ~ 0
   ),
   Homeless = case_when(
     `Homeless:` == "Yes" ~ 1,
     TRUE ~ 0
   ),
   HousingIssues = case_when(
     `HousingIssues:` == "Yes" ~ 1,
     TRUE ~ 0
   ),
   Citizenship = case_when(
     `Citizenship:` == "Yes" ~ 1,
     TRUE ~ 0
   ),
   Obese = case_when(
     `BMI>35:` == "Yes" ~ 1,
     TRUE ~ 0,
     
   )) %>%
  select(c("Premature:", "LowBirthWeight:", "Age","deprivedArea",
           "NumberOfBabies","BAME", "Consanguineous", "FGM",
           "MentalHealth", "DomesticAbuse", "DrugAbuse", 
           "AlcoholAbuse", "substanceAbuse","SmokingAtDelivery",
           "Obese", "Homeless","HousingIssues", "Citizenship"
           )) %>%
  tidyr::drop_na()
```

The following is a correlation matrix for our primary variables.

```{r corr_mat, echo=FALSE}
corrplot::corrplot(cor(badger2),
         method="color", 
         diag = FALSE, 
         type = 'upper')
# Save memory
rm("badger2")
```


We see that there is a strong correlation between `DrugAbuse` and `substanceAbuse`.
Therefore, it is best that we remove on of these variables. Since there are more
`substanceAbuse` cases and all `DrugAbuse` cases are also `substanceAbuse` cases, we 
therefore choose to remove the `DrugAbuse` variable.

# Dual Diagnosis

For the purposes of this analysis, we define dual diagnosis to be the combination
of `MentalHealth` and `substanceAbuse`.

```{r def_dual, include=FALSE}
all_variables = c("`DualDiagnosis:`",  "`NumberOfBabies:`","`Agelessthan20:`", "`DomesticAbuse:`", "`Ethnicity:`", "`LearningDisabilities:`", "`Citizenship:`", "`Unsupported:`")

# define Dual Diagnosis
badger <- badger %>% 
  mutate(
    `DualDiagnosis:` = case_when(
      (`substanceAbuse:` == "Yes") & (`MentalHealth:` == "Yes") ~ "Yes",
      TRUE ~ "No"
    )
  )
dual_count_comp <- badger %>%
  select(c("MentalHealth:", "substanceAbuse:","DualDiagnosis:")) %>%
  summary()

badger <- badger %>%
  select(contains(main_cols))

# Add as factor
badger[["DualDiagnosis:"]] <- relevel(factor(badger[["DualDiagnosis:"]]), ref = "No")
```

```{r comment='', echo=FALSE, results='asis'}
 knitr::kable(dual_count_comp, caption = "Number of pregnancies in data with MentalHealth, substanceAbuse and DualDiagnosis respectively.")
```

## Who has dual diagnosis?

We can now perform a breakdown of who has dual diagnosis across our variables of interest. This is shown in the table below. 

```{r dual_diag_breakdown, echo=FALSE}
## define custom test
fisher.test.simulate.p.values <- function(data, variable, by, ...) {
  result <- list()
  test_results <- stats::fisher.test(data[[variable]], data[[by]], 
                                     simulate.p.value = TRUE)
  result$p <- test_results$p.value
  result$test <- test_results$method
  result
}

badger %>%
  select(-c("LowBirthWeight:", "Premature:")) %>%
  tbl_summary(by = `DualDiagnosis:`) %>%
  add_p(
    test = list(all_categorical() ~ "fisher.test.simulate.p.values")
  ) %>%
  modify_header(label = "**Variable**") %>%
  as_gt()

```

We see from the table above that mothers with dual diagnosis are statistically more likely to be in situations of domestic abuse, have one or more learning disabilities and are also less likely to be supported during the pregnancy.

# Basic regression

## Low-birth weight
```{r basic_reg_lbw, include = FALSE}
# build formula
lbw_formula <- write_formula("`LowBirthWeight:`", all_variables)
print(lbw_formula)

# run logistic regression
model_lbw <- glm(lbw_formula, family = binomial, data=badger)

# find most important variables
varImp_lbw <- var_imp(model_lbw)

```

We perform a simple regression to predict the probability of low birth weight using the formula `r lbw_formula`.

The ten most important variable are given below.

```{r comment='', echo=FALSE, results='asis'}
 knitr::kable(head(varImp_lbw, 10), caption = "Ten most important variables for predicting the probability of low birth weight.")
```

## Premature birth
```{r basic_reg_prem, include=FALSE, echo=FALSE, include=FALSE}
# build formula
prem_formula <- write_formula("`Premature:`", all_variables)
print(prem_formula)

# run logistic regression
model_prem <- glm(prem_formula, family = binomial, data=badger)

# find most important variables
varImp_prem <- var_imp(model_prem)
```

We perform a simple regression to predict the probability of low birth weight using the formula `r prem_formula`.

The ten most important variable are given below.

```{r comment='', echo=FALSE, results='asis'}
 knitr::kable(head(varImp_prem, 10), caption = "Ten most important variables for predicting the probability of low birth weight.")
```

## Basic regression final results
```{r}
# merge tables 
tbl_output <-
  tbl_merge(
    tbls = list(
      tbl_regression(model_lbw, exponentiate = TRUE), 
      tbl_regression(model_prem, exponentiate = TRUE)),
    tab_spanner = c("**Low birth weight**", "**Premature Birth**")
  ) %>%
  as_gt()

tbl_output
```

# Looking for interaction terms

```{r get_important_list, include=FALSE}
# most important from LBW birth model
lbw_vars <- varImp_lbw %>% 
  filter(Importance > imp_thresh) 

lbw_imp <- str_split_fixed(lbw_vars$Variable, ":",2)[,1]

# most important from premature birth model
prem_vars <- varImp_prem %>% 
  filter(Importance > imp_thresh) 

prem_imp <- str_split_fixed(prem_vars$Variable, ":",2)[,1]

all_important <- paste(unique(c(lbw_imp, prem_imp)), ":`", sep = "")
```


Since there are too many possible interaction terms to investigate them all, we 
instead look for any interaction terms between our most important variables. 
We define this group as any variable with an importance greater than 
`r imp_thresh`.

Additionally, for simplicity we want our formulas for low birth weight and
premature birth to be the same so we combine both lists. The resulting list is:

```{r print_important}
print(all_important)
```

We also choose to only look for interactions between pairs of variables. 
This we can build the corresponding formula using `write_formula(.., pairs = TRUE)`.

## Low birth weight

```{r lbw_marg_1, include=FALSE}
# build formula
lbw_formula2 <- write_formula("`LowBirthWeight:`", all_important, pairs = TRUE)

# run logistic regression
model_lbw2 <- glm(lbw_formula2, family = binomial, data=badger)

# find most important marginal effects
MargImp_lbw <- var_imp(model_lbw2) 
MargImp_lbw$Marginal <- str_count(MargImp_lbw$Variable,":") > 1
MargImp_lbw <- MargImp_lbw %>%
  filter(Marginal) %>%
  select(-c("Marginal"))

lbw_marg2 <- MargImp_lbw %>% 
  mutate(`Interaction term` =  paste(str_split_fixed(Variable, ":",4)[,1], "*",
                 str_split_fixed(Variable, ":",4)[,3]),
         model = "LBW")
```

```{r comment='', echo=FALSE, results='asis'}
 knitr::kable(head(lbw_marg2, 10), caption = "10 most imporant interaction terms for low birth weight.")
```

## Premature Birth

```{r prem_marg_1, include=FALSE}
# build formula
prem_formula2 <- write_formula("`Premature:`", all_important, pairs = TRUE)

# run logistic regression
model_prem2 <- glm(prem_formula2, family = binomial, data=badger)

# find most important marginal effects
MargImp_prem <- var_imp(model_prem2) 
MargImp_prem$Marginal <- str_count(MargImp_prem$Variable,":") > 1
MargImp_prem <- MargImp_prem %>%
  filter(Marginal) %>%
  select(-c("Marginal"))

prem_marg2 <- MargImp_prem %>% 
  mutate(`Interaction term` = paste(str_split_fixed(Variable, ":",4)[,1], "*",
                 str_split_fixed(Variable, ":",4)[,3]),
         model = "Premature")
```

```{r comment='', echo=FALSE, results='asis'}
 knitr::kable(head(prem_marg2, 10), caption = "10 most imporant interaction terms for premature birth.")
```

## Most important interaction terms

```{r get_imporant_marginals, include=FALSE}

important_marginals <- rbind(lbw_marg2, prem_marg2) %>% 
  filter(Importance > imp_thresh) %>%
  select(c("Interaction term", "Importance", "Rank", "model")) %>%
  distinct() %>%
  arrange(desc(Importance))

```

We find that none of the interaction terms surpass our importance threshold of `r imp_thresh`. However, if we consider a slightly lower threshold of 2.5 then we find more interaction term
of importance:

```{r get_imporant_marginals2, include=FALSE}
# most important from LBW birth model
lbw_marg2 <- MargImp_lbw %>% 
  filter(Importance > 2.5) %>%
  mutate(`Interaction term` =  paste(str_split_fixed(Variable, ":",4)[,1], "*",
                 str_split_fixed(Variable, ":",4)[,3]),
         model = "LBW")


prem_marg2 <- MargImp_prem %>% 
  filter(Importance > 2.5) %>%
  mutate(`Interaction term` = paste(str_split_fixed(Variable, ":",4)[,1], "*",
                 str_split_fixed(Variable, ":",4)[,3]),
         model = "Premature")

important_marginals2 <- rbind(lbw_marg2, prem_marg2) %>% 
  select(c("Interaction term", "Importance", "Rank", "model")) %>%
  distinct() %>%
  arrange(desc(Importance))

```


```{r comment='', echo=FALSE, results='asis'}
 knitr::kable(important_marginals2, caption = "Maximum importance of interaction terms with imporance value greater than 2.5")
```

# Regression with interaction term(s)

```{r add_marginal, include=FALSE}
all_variables_plus <- c(all_variables, "`NumberOfBabies:` * `Ethnicity:`")
formula_plus <- write_formula("`Output:`", all_variables_plus)
```
Adding the one important interaction term, our formula now becomes:

`r formula_plus`

## Perform regression agian

```{r final_reg, include = FALSE}
# Perform regressions
lbw_ff <- write_formula("`LowBirthWeight:`", all_variables_plus)
model_lbw_final <- glm(lbw_ff, family = binomial, data=badger)

prem_ff <- write_formula("`Premature:`", all_variables_plus)
model_prem_final <- glm(prem_ff, family = binomial, data=badger)
```

```{r collate_results, include = FALSE}
lbw_odds <- odds_ratios(model_lbw_final, rm_na = TRUE, ref = ref)

prem_odds <- odds_ratios(model_prem_final, rm_na = TRUE, ref = ref)
dataset_names <- list(
  'LBW' = lbw_odds,
  'Prem' = prem_odds)

write.xlsx(
  dataset_names, 
  file = '../../../data/outputs/BN_regs_DD.xlsx'
  )

# merge tables 
tbl_output <-
  tbl_merge(
    tbls = list(
      tbl_regression(model_lbw_final, exponentiate = TRUE), 
      tbl_regression(model_prem_final, exponentiate = TRUE)),
    tab_spanner = c("**Low birth weight**", "**Premature Birth**")
  ) %>%
  as_gt()
tbl_output
```
## Display results

Graphed results shown below.

```{r, out.width = "100%", fig.cap = "Relative Odds Ratio for final low-birth-weight model.", echo= FALSE}
knitr::include_graphics("../../../outputs/figures/BN_reg_DD_LBW.pdf") 
```

```{r, out.width = "100%", fig.cap = "Relative Odds Ratio for final premature birth model.", echo= FALSE}
knitr::include_graphics("../../../outputs/figures/BN_reg_DD_prem.pdf") 
```